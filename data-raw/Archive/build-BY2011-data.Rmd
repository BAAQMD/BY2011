---
title: "BY2011 Data"
output: html_document
--- 

## Setup

```{r libraries, message = FALSE}
library(inventory)
opts_chunk$set(echo = TRUE, cache = FALSE)
options(width = 100, digits = 3)
equals <- magrittr::equals
if (interactive()) try(setwd("data-raw"))
```

***

## Data

### Area sources

1. Assemble District-wide totals

    - Import and tidy contents of `BY2011-annual-A.csv`
    - Convert from implicit `ton/day` to explicit `ton/year` (short tons)

2. Downscale, yielding `ems_qty` for each (`year`, `cnty_abbr`, `pol_abbr`)
    
    - Look to `county_throughputs(2011, na.rm = FALSE)` for 2011 county fractions

3. Speciate `TOG` and `PM`

    - Mass fractions applied to `TOG` (yielding `TOG` and `ROG`) according to `FROG11BY11.csv`
    - Mass fractions applied to `PM` (yielding `TSP`, `PM10`, and `PM2.5`) according to `TFPM1011_BY11.csv`

4. **Patch**  SF6 emissions

    - Append SF6 county subtotals from `area_source_projections(2011)` (category #1596)
    - Reason: No SF6 emissions included in `BY2011-annual-A.csv`

```{r BY2011_A.district_totals}
```

```{r BY2011_A.SF6}
BY2011_A.SF6.district_totals <-
  read_xls("Data/BY2011-annual-A-SF6.xlsx") %>%
  transmute(year = as.integer(Year), cat_id = as.integer(cat_id), pol_abbr = "SF6", ems_qty = SF6, ems_unit = Unit) %>%
  filter(year >= 1990) %>%
  convert_emission_units(from = "ton/day", to = "ton/yr")

BY2011_A.SF6.county_fractions <-
  county_throughputs(base_year = 2011, na.rm = FALSE) %>% 
  select(cat_id, cnty_abbr, cnty_frac)

BY2011_A.SF6 <-
  BY2011_A.SF6.district_totals %>%
  left_join(BY2011_A.SF6.county_fractions, by = "cat_id") %>%
  mutate(ems_qty = ems_qty * cnty_frac) %>%
  select(-cnty_frac)
```

```{r BY2011_A.county_fractions}
BY2011_A.county_fractions <- local({
  
  Ingres.county_fractions <-
    county_throughputs(base_year = 2011, na.rm = FALSE) %>%
    select(cat_id, cnty_abbr, cnty_frac) %>%
    semi_join(BY2011_A.district_totals, by = "cat_id")
  
  assumed_fractions <-
    data_frame(cat_id = int(1596), cnty_abbr = names(BAAQMD_COUNTIES), cnty_frac = 1/9)
  
  bind_rows(Ingres.county_fractions, assumed_fractions) %>%
    ensure_distinct(cat_id, cnty_abbr) %>%
    ensure(is.integer(.$cat_id))
  
})
  
# Sanity check(s)
BY2011_A.county_fractions %>% filter(cat_id %in% c(1646, 1763)) %>% spread(cnty_abbr, cnty_frac)
```

```{r spec_files}
BY2011_ROG_spec_file <- 
  my_dropbox("Emissions Inventory", "Archive", "BY2011", "Speciation", "FROG11BY11.csv")

BY2011_PM_spec_file <-
  my_dropbox("Emissions Inventory", "Archive", "BY2011", "Speciation", "TFPM1011_BY11.csv")
```

```{r BY2011_A}
# Apportion to counties on the basis of throughputs
BY2011_A <-
  BY2011_A.district_totals %>%
  ensure_distinct(year, cat_id, pol_abbr) %>%
  left_join(BY2011_A.county_fractions, by = c("cat_id")) %>%
  mutate(ems_qty = ems_qty * cnty_frac) %>%
  select(year, cnty_abbr, cat_id, pol_abbr, ems_qty, ems_unit) %>%
  bind_rows(BY2011_A.SF6) %>%
  speciate_TOG(using = BY2011_ROG_spec_file) %>%
  speciate_PM(into = c("TSP", "PM10", "PM2.5"), using = BY2011_PM_spec_file) %>%
  ensure_distinct(year, cat_id, pol_abbr, cnty_abbr) %>%
  ensure(all_true(.$year %in% 1990:2030),
         all_true(.$cnty_abbr %in% c("ALA", "CC", "MAR", "NAP", "SF", "SM", "SON", "SOL", "SNC")),
         all_true(.$cat_id > 0), 
         is.integer(.$cat_id),
         all_true(!is.na(.$pol_abbr)),
         all_true(.$ems_qty >= 0))

# Short but descriptive comment
comment(BY2011_A) <- 
  "BY2011 area source emissions, by category and county, 1990â€”2030."

# Quick peek, for the record
BY2011_A %>% per_day() %>% glimpse
```

```{r BY2011_A_NOx_comparison}
BY2011_A_NOx_comparison <- compare_emissions(
  original = BY2011_A.district_totals %>% sum_annual_emissions_by(pol_abbr) %>% filter(pol_abbr == "NOx"),
  derived  = BY2011_A %>% sum_annual_emissions_by(pol_abbr) %>% filter(pol_abbr == "NOx"))

BY2011_A_NOx_comparison %>%
  mutate(net_diff = original - derived, 
         rel_orig = net_diff / original) %>%
  filter(is.na(net_diff) | abs(rel_orig) > 0.01) %>%
  ensure(nrow(.) == 0) %>%
  print_tbl("Discrepancies between `BY2011_A.district_totals` and `BY2011_A` (annual NOx only). Should be empty.")
```


***

### Point sources

1. Derive county fractions for *active* `(cat_id, pol_abbr)` combinations

    - Start with `point_source_emissions(base_year = 2011, active_only = FALSE)`
    - Sum to arrive at county-level emissions **for each pollutant**
    - Divide by District-level totals, yielding `cnty_frac`
    
2. Combine with county fractions for *defunct* `(cat_id, pol_abbr)` combinations

    - Otherwise, some historically active (defunct) sources would not be assigned county fraction(s)
    - NOTE: apportionment of `(cat_id, pol_abbr)` amongst 9 counties is invariant with respect to year (so long as there were emissions in that year)
    - See inline comments in code below for very specific details

3. Assemble District-wide totals 

    - Import and tidy contents of `BY2011-annual-A.csv`
    - Convert from implicit `ton/day` to explicit `ton/year` (short tons)

4. Patch SF6 emissions
    
    - Look to `point_source_projections(base_year = 2011, year = 1990:2030, na.rm = FALSE)
    - `na.rm = FALSE` so that `NY` flags will be ignored and we'll get `1990:2010` backcasts
    - Appears to be only category `#54`

```{r BY2011_P.county_fractions, results = "asis"}
# Retrieve 2011 "actuals" from Ingres
Ingres_data <- 
  point_source_emissions(base_year = 2011, na.rm = FALSE) # include "defunct" (closed) facilities

Ingres_P.county_fractions <- local({
  
  # Recode "HFCs" and "PFCs" as "HFC+PFC", so that they'll be summed together.
  # Then tabulate by county, omitting the few records that aren't labeled with a county.
  Ingres.county_subtotals <-
    Ingres_data %>%
    filter(!is.na(cnty_abbr)) %>%
    mutate(pol_abbr = pol_abbr %>% replace_which(. %in% c("HFCs", "PFCs"), "HFC+PFC")) %>%
    group_by(pol_abbr, cat_id, cnty_abbr) %>%
    total_emissions()   
  
  # Derive *pollutant-specific* county fractions from Ingres "actuals"
  Ingres.county_subtotals %>%
    group_by(pol_abbr, cat_id) %>%
    mutate(cnty_frac = ems_qty / total(ems_qty)) %>%
    select(pol_abbr, cat_id, cnty_abbr, cnty_frac) %>%
    ensure(all(.$cnty_frac > 0), all(.$cnty_frac <= 1))
  
})

# A few point sources don't have a valid county identifier. We're omitting them.
Ingres_data %>% 
  filter(is.na(cnty_abbr)) %>% 
  with_facility_name() %>%
  print_tbl("Records from Ingres (t0891 & t0761) missing county identifier(s).")
```

```{r BY2011_P.SF6-new}
BY2011_P.SF6.district_totals <-
  read_xls("Data/BY2011-annual-P-SF6.xlsx") %>%
  transmute(year = Year, cat_id = cat_id, pol_abbr = "SF6", ems_qty = SF6, ems_unit = Unit) %>%
  filter(year >= 1990) %>%
  convert_emission_units(from = "ton/day", to = "ton/yr")

BY2011_P.SF6.county_fractions <-
  county_throughputs(base_year = 2011, na.rm = FALSE) %>% 
  select(cat_id, cnty_abbr, cnty_frac)

BY2011_A.SF6 <-
  BY2011_A.SF6.district_totals %>%
  left_join(BY2011_A.SF6.county_fractions, by = "cat_id") %>%
  mutate(ems_qty = ems_qty * cnty_frac) %>%
  select(-cnty_frac)
```

```{r BY2011_P.SF6}
# Retrieve SF6 point source data records from Ingres and sum by county
BY2011_P.SF6 <- 
  point_source_projections(base_year = 2011, year = 1990:2030, na.rm = FALSE) %>%
  filter(pol_abbr == "SF6") %>%
  select(year, cnty_abbr, cat_id, pol_abbr, ems_qty, ems_unit)
```

```{r BY2011_P.district_totals}
BY2011_P.district_totals <- 
  read_csv("Data/BY2011-annual-P.csv", col_types = "icicdddddddddd") %>%
  #ensure(md5(.) %>% equals("4ab2947fe95939a4b92b0b5d5772e88b")) %>%
  ensure(all_true(.$season == "Annual")) %>%
  ensure(all_true(.$cat_type == "Point")) %>%
  rename(year = yr, cat_id = cat_no, CO2_bio = BCO2, `HFC+PFC` = HFC, SO2 = SOx) %>%
  ensure(min(.$year) == 1990) %>%
  ensure(max(.$year) == 2030) %>%
  select(-season, -cat_type) %>%
  gather(pol_abbr, ems_qty, PM, TOG, NOx, SO2, CO, CO2, CH4, N2O, `HFC+PFC`, CO2_bio) %>%
  filter(ems_qty > 0) %>%
  mutate(pol_abbr = as.character(pol_abbr),
         ems_unit = "ton/day") %>%
  select(year, cat_id, pol_abbr, ems_qty, ems_unit) %>%
  per_year()
```

```{r patches, results = "asis"}
BY2011_COUNTIES <- c("ALA", "CC", "MAR", "NAP", "SF", "SM", "SON", "SOL", "SNC")
BY2011_POLLUTANTS <- unique(BY2011_P.district_totals$pol_abbr)

# Helper function
expand_grid <- function (...) as.tbl(expand.grid(..., stringsAsFactors = FALSE))

# Here are patches for defunct categories and/or facilities.
# Counties were deduced by examining t0898, t0891, etc. (T-tables for point source emissions).
BY2011_P.county_fractions <- local({
  
  historical_patches <- bind_rows(
    
    # All emissions from coal combustion at plant #17 Lehigh 
    # (no Ingres records after 2009)
    data_frame(pol_abbr = BY2011_POLLUTANTS, cat_id = 1748, cnty_abbr = "SNC"), 
    
    # All emissions from oil fired boiler(s) at plant #15263 Bottling Group LLC 
    # (no Ingres records after 2008)
    data_frame(pol_abbr = BY2011_POLLUTANTS, cat_id = 294, cnty_abbr = "ALA"), 
     
    # NOx from "Other Refining Processes" at plant #14630 Tesoro Refining and Marketing Company 
    # (no Ingres records after 2010)
    data_frame(pol_abbr = "NOx", cat_id = 16, cnty_abbr = "CC"),    
    
    # NOx from "Basic Refining Processes" at plant #14628 Tesoro Refining & Marketing Company LLC 
    # (no Ingres records after 2008 *but* estimates for 2009 in P file(s))
    data_frame(pol_abbr = "NOx", cat_id = 10, cnty_abbr = "CC"),  
    
    # All emissions from "Reciprocating Engines, Gasoline" at plant #7416 Clean Air Vehicle Test Center 
    # (Ingres records exist only (?) for 2008, *but* there are estimates for 2008 and 2009 in P file(s))
    data_frame(pol_abbr = BY2011_POLLUTANTS, cat_id = 302, cnty_abbr = "ALA"),  
    
    # TOG from "Wineries, Fermentation" at plant #606 Anheuser-Busch LLC 
    # (reclassified as #33 "Other Food & Agricultural Processes" after 2010)
    # FIXME: this omits plant #1648 Sonoma Wine Company (minor)
    data_frame(pol_abbr = "TOG", cat_id = 31, cnty_abbr = "SOL"),    
    
    # TOG from "Vacuum Producing Systems" at refineries
    # (no Ingres records after 1997)
    data_frame(pol_abbr = "TOG", cat_id = 14, cnty_abbr = "CC"),    
    
    # "Dry Cleaners, Other Synthetic Solvents"
    # FIXME: for 2007, there are actually only Ingres records for SNC, MAR, and ALA
    data_frame(pol_abbr = "TOG", cat_id = 106, cnty_abbr = BY2011_COUNTIES)    
    
  ) %>%
  group_by(pol_abbr, cat_id) %>%
  mutate(cnty_frac = 1 / length(cnty_abbr))

  # Print table of historical patches
  historical_patches %>%
    select(cat_id, pol_abbr, cnty_abbr, cnty_frac) %>%
    spread(cnty_abbr, cnty_frac) %>%
    with_hierarchy(depth = 5) %>%
    select(-cat_h1, -cat_h2) %>%
    print_tbl("County fractions for historically active (defunct) point sources.")

  # Combine patches with properly calculated county fractions
  bind_rows(Ingres_P.county_fractions, 
            historical_patches)

})

# Double-check that nothing is left unaccounted for
BY2011_P.district_totals %>% 
  anti_join(BY2011_P.county_fractions) %>% 
  ensurer::check(nrow(.) == 0)
```

```{r BY2011_P}
# Apportion to counties
BY2011_P <- 
  BY2011_P.district_totals  %>%
  left_join(BY2011_P.county_fractions, by = c("pol_abbr", "cat_id")) %>%
  mutate(ems_qty = ems_qty * cnty_frac) %>%
  ensure(all(.$ems_qty %>% is.finite)) %>%
  mutate(cat_id = as.integer(cat_id)) %>%
  bind_rows(BY2011_P.SF6) %>%
  select(year, cnty_abbr, cat_id, pol_abbr, ems_qty, ems_unit) %>%
  ensure(all_true(.$year %in% 1990:2030),
         all_true(.$cnty_abbr %in% c("ALA", "CC", "MAR", "NAP", "SF", "SM", "SON", "SOL", "SNC")),
         all_true(.$cat_id > 0),
         all_true(!is.na(.$pol_abbr)),
         all_true(.$ems_qty > 0)) %>%
  speciate_TOG(using = my_dropbox("Emissions Inventory", "Archive", "BY2011", "Speciation", "FROG11BY11.csv")) %>%
  speciate_PM(into = c("TSP", "PM10", "PM2.5"),
              using = my_dropbox("Emissions Inventory", "Archive", "BY2011", "Speciation", "TFPM1011_BY11.csv"))

# Check for quantitiative errors (except F-gases)
BY2011_P.cmp <-
  BY2011_P %>% 
  mutate(pol_abbr = pol_abbr %>% replace_which(. == "TSP", "PM")) %>%
  filter(pol_abbr %not_in% c("PM10", "PM2.5", "ROG", "SF6")) %>%
  group_by(year, pol_abbr, cat_id) %>% 
  total_emissions() %>% 
  rename(BY2011_P = ems_qty) %>%
  full_join(BY2011_P.district_totals %>% rename(published = ems_qty),
            by = c("year", "pol_abbr", "cat_id", "ems_unit")) %>%
  ungroup()

# Show any that aren't good to 1 part per million
#is_less_than <- magrittr::is_less_than
#BY2011_P.cmp %>% 
#  mutate(abs_err = abs(BY2011_P - published)) %>%
#  check(.$abs_err %>% is.finite %>% all_true,
#         .$abs_err %>% is_less_than(0.001) %>% all_true)

# Short but descriptive comment
comment(BY2011_P) <- 
  "BY2011 point source emissions, by category and county, 1990â€”2030"

# Quick peek, for the record
BY2011_P %>% per_day() %>% glimpse
```

```{r BY2011_P_NOx_comparison}
BY2011_P_NOx_comparison <- compare_emissions(
  original = BY2011_P.district_totals %>% sum_annual_emissions_by(pol_abbr) %>% filter(pol_abbr == "NOx"),
  derived  = BY2011_P %>% sum_annual_emissions_by(pol_abbr) %>% filter(pol_abbr == "NOx"))

BY2011_P_NOx_comparison %>%
  mutate(net_diff = original - derived, 
         rel_orig = net_diff / original) %>%
  filter(is.na(net_diff) | abs(rel_orig) > 0.01) %>%
  ensure(nrow(.) == 0) %>%
  print_tbl("Discrepancies between `BY2011_P.district_totals` and `BY2011_P` (annual NOx only). Should be empty.")
```

***

### Motor vehicles

```{r BY2011_M}
BY2011_M <- 
  read_csv("Data/BY2011-annual-M.csv") %>%
  ensure(all_true(.$ems_unit == "tons_per_day")) %>%
  mutate(pol_abbr = recode(pol_abbr, c(PM25 = "PM2.5")),
         ems_unit = "ton/day",
         year = as.integer(year),
         cat_id = as.integer(cat_id),
         cnty_abbr = str_extract(cnty_abbr, "[A-Z]+")) %>%
  ensure(min(.$year) == 1990) %>%
  ensure(max(.$year) == 2035) %>%
  filter(ems_qty > 0) %>%
  filter(cnty_abbr != "TOT") %>%
  select(year, cnty_abbr, cat_id, pol_abbr, ems_qty, ems_unit) %>%
  per_year() %>%
  ensure(all_true(.$year %in% 1990:2035),
         all_true(.$cnty_abbr %in% c("ALA", "CC", "MAR", "NAP", "SF", "SM", "SON", "SOL", "SNC")),
         all_true(.$cat_id > 0),
         all_true(!is.na(.$pol_abbr)),
         all_true(.$ems_qty > 0))

comment(BY2011_M) <- 
  "BY2011 motor vehicle emissions, by category and county, 1990â€”2035"

# Quick peek, for the record
BY2011_M %>% glimpse
```

***

## Final (speciated) result

- Bind `BY2011_A` together with `BY2011_P`
- Speciate selected pollutants
    - `PM` becomes `TSP`, `PM10`, and `PM2.5`
    - `TOG` becomes `TOG` and `ROG`
- Bind with motor vehicles (which are already speciated)

```{r BY2011_annual}
BY2011_annual <-
  bind_rows(BY2011_A, BY2011_P, BY2011_M) %>%
  filter(year <= 2030) %>%
  ensure(all_true(.$year %in% 1990:2030),
         all_true(.$cnty_abbr %in% c("ALA", "CC", "MAR", "NAP", "SF", "SM", "SON", "SOL", "SNC")),
         all_true(.$cat_id > 0),
         all_true(!is.na(.$pol_abbr)),
         all_true(.$ems_qty >= 0)) %>%
  filter(ems_qty > 0)

comment(BY2011_annual) <- 
  "BY2011 emissions, by category and county, 1990â€”2030"

# Quick peek, for the record
BY2011_annual %>% glimpse
```

***

## Summaries

```{r BY2011_sets}
BY2011_sets <- list()

BY2011_sets[["Unreported"]] <- 
  list(
    "Organic gases, biogenic" = int(784:787),
    "Ships in transit, distillate fuel (>3 to 24 nmiles)" = int(2185:2202),
    "Ships in transit, residual fuel (>24 to 100 nmiles)" = int(2203:2220), 
    "Commercial harbor craft (>3 to 24 nmiles)" = int(2225:2242), 
    "Commercial harbor craft (>24 to 100 nmiles)" = int(2243:2260)
  ) %>% unlist() %>% unname()

BY2011_sets[["Motor vehicles"]] <-
  sort(unique(BY2011_M$cat_id))

BY2011_sets[["Area sources"]] <-
  sort(unique(BY2011_A$cat_id))

BY2011_sets[["Point sources"]] <-
  sort(unique(BY2011_P$cat_id))
```

### By year

```{r BY2011_annual-by_year, results = "asis"}
BY2011_annual %>%
  ensure(is.integer(.$cat_id)) %>%
  filter(cat_id %not_in% BY2011_sets[["Unreported"]]) %>%
  filter(year %in% 1990:2030) %>%
  group_by(year, pol_abbr) %>%
  per_day() %>%
  total_emissions() %>%
  spread(pol_abbr, ems_qty) %>% 
  select(-ems_unit) %>%
  print_tbl("BY2011_annual: 1990-2030 emissions by year and pollutant (ton/day).", digits = 2)
```

***

### By county

```{r BY2011_annual-by_county, results = "asis"}
BY2011_annual %>%
  filter(cat_id %not_in% BY2011_sets[["Unreported"]]) %>%
  filter(year == 2011) %>%
  group_by(cnty_abbr, pol_abbr) %>%
  per_day() %>%
  total_emissions() %>%
  spread(pol_abbr, ems_qty) %>% 
  select(-ems_unit) %>%
  print_tbl("BY2011_annual: 2011 emissions by county and pollutant (ton/day).", digits = 2)
```

***

```{r save_data, echo = FALSE}
BY2011_GWPs <- c(
  "CO2"       = 1,
  "CO2_bio"   = 0,
  "CH4"       = 21,     # IPCC SAR (1995)
  "N2O"       = 310,    # IPCC SAR (1995)
  "SF6"       = 23900,  # IPCC SAR (1995)
  "HFC+PFC"   = 1796)   # BAAQMD composite (for point sources)

message("Constructing BY2011_categories from t1327 and t1325")
BY2011_categories <-
  inventory::DataBank_hierarchy(t1327) %>%
  semi_join(t1325 %>% rename(cat_id = p))

# Save the datasets to the same .Rda file
save(
  BY2011_annual, BY2011_data, BY2011_sets, BY2011_GWPs, BY2011_categories,
  file = file.path(WORKING_DIR, "BY2011.rda"))

file.copy(
  from = file.path(WORKING_DIR, "BY2011.rda"),  # case sensitive!
  to = my_dropbox("R-packages", "inventory", "data", "BY2011.rda"),
  overwrite = TRUE)
```

### By category

```{r BY2011_annual-pivot_table_for-all_categories}
BY2011_annual %>%
  filter(year == 2011) %>%
  group_by(year, cat_id, cnty_abbr, pol_abbr) %>%
  per_day() %>%
  total_emissions(digits = 2) %>%
  select(-ems_unit) %>%
  with_staff() %>%
  with_hierarchy("LEVHH11R.csv") %>%
  filter(cat_id %not_in% BY2011_sets[["Unreported"]]) %>%
  pivot_table(rows = c("cat_h1", "cat_h2"), 
              columns = "pol_abbr",
              caption = "BY2011: 2011 emissions, excluding ships > 3 nm offshore (ton/day).")
```
